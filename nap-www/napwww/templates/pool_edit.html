{% extends "base.html" %}
{% set page = 'pools' %}

{% block head %}

   <script>

    var indent_head = Array();

    function showPrefix(prefix, parent_container) {

        // add main prefix container
        parent_container.append('<div id="prefix_entry' + prefix.id + '">');
        var prefix_entry = $('#prefix_entry' + prefix.id);
        prefix_entry.attr('class', 'prefix_entry');
        prefix_entry.hover(
            function() { prefix_entry.addClass("row_hover"); },
            function() { prefix_entry.removeClass("row_hover"); }
        );

        // add indent and prefix container
        prefix_entry.append('<div id="prefix_ind_pref' + prefix.id + '">');
        var prefix_ind_pref = $('#prefix_ind_pref' + prefix.id);
        prefix_ind_pref.addClass('prefix_ind_pref');

        // add indent
        prefix_ind_pref.append('<div id="prefix_indent' + prefix.id + '">');
        var prefix_indent = $('#prefix_indent' + prefix.id);
        prefix_indent.addClass("prefix_indent");
        prefix_indent.html('<span class="exp_button" id="prefix_exp' + prefix.id + '" onClick="collapse(' + prefix.id + ')">&nbsp;-&nbsp;</span>');
        prefix_indent.width(prefix_indent.width() + 30 * prefix.indent);

        // add prefix
        prefix_ind_pref.append('<div id="prefix_prefix' + prefix.id + '">');
        var prefix_prefix = $('#prefix_prefix' + prefix.id);
        prefix_prefix.addClass("prefix_prefix");
        prefix_prefix.html('<a href="/pool/add_prefix/{{ c.pool.id }}/' + prefix.id + '" onClick="selectPrefix(' + prefix.id + '); return false;">' + prefix.display_prefix + '</a>');

        // Add prefix type
        prefix_entry.append('<div id="prefix_type' + prefix.id + '">');
        var prefix_type = $('#prefix_type' + prefix.id);
        prefix_type.addClass("prefix_type");
        prefix_type.html(prefix.type);

        // Add prefix description
        prefix_entry.append('<div id="prefix_description' + prefix.id + '">'); 
        var prefix_description = $('#prefix_description' + prefix.id);
        prefix_description.addClass("prefix_description");
        prefix_description.html(prefix.description);

    }


    /*
     * Is run when a prefix is selected in the list.
     */
    function selectPrefix(prefix_id) {

        // set prefix's pool attribute in Nap
        data = new Object();
        data.schema = schema_id;
        data.id = prefix_id;
        data.pool = {{ c.pool.id }};
        $.getJSON('{{ h.url(controller = 'xhr', action = 'edit_prefix') }}', data, prefixAdded);
    
    }

    /*
     * Run when prefix has been added to pool
     */
    function prefixAdded(prefix) {

        // Error?
        if ('error' in prefix) {
            displayNotice("Error", prefix.message);
            return;
        }
        
        // display prefix in list
        $("#pool_prefix_list").append('<tr id="pool_prefix_' + prefix.id + '">');
        $("#pool_prefix_" + prefix.id).append('<td>' + prefix.display_prefix + '</td>');
        $("#pool_prefix_" + prefix.id).append('<td>' + prefix.description + '</td>');
        $("#pool_prefix_" + prefix.id).append('<td><a href="/pool/remove_prefix/{{ c.pool.id }}?schema=' + schema_id + '&prefix='+ prefix.id +'">del</a></td>');

    }

    /*
     * Callback function called when prefixes are received.
     * Plots prefixes and adds them to list.
     */
    function receivePrefixList(pref_list) {

        /*
         * Interpretation list
         */

        var intp_cont = $("#search_interpret_container");
        intp_cont.empty();
        for (key in pref_list.interpretation) {

            var interp = pref_list.interpretation[key];
            intp_cont.append('<div class="search_interpretation" id="intp' + key + '">');
            $('#intp' + key).html('<b>' + interp.string + '</b> interpreted as ' + interp.interpretation);

        }

        /*
         * Prefix list
         */

        $('#prefix_list').empty();
        indent_head[0] = $('#prefix_list');

        // add prefixes
        for (key in pref_list.result) {

            var cur_prefix = pref_list.result[key];

            // add prefixes to list - first a special case for the first prefix
            if (key == 0) {
                showPrefix(cur_prefix, indent_head[0]);
            } else {
                
                // indent increased - create new collapse group
                var prev_prefix = pref_list.result[key - 1];
                if (cur_prefix.indent > prev_prefix.indent) {
                    indent_head[prev_prefix.indent].append('<div id="collapse' + prev_prefix.id + '">');
                    indent_head[cur_prefix.indent] = $('#collapse' + prev_prefix.id);
                }

                showPrefix(cur_prefix, indent_head[cur_prefix.indent]);

            }
        }

    }

	/*
	 * Display step 2 of pool expansion procedure
	 */
    function displayStep2(e) {

        // allocate new prefix
        if (e.currentTarget.id == 'radio-create-new') {
            $('#exp-select-existing_container').hide();
            alert("Not implemented!");

        // select already existing prefix
        } else {
            $('#exp-select-existing_container').show();
            $("html,body").animate({scrollTop: $("#exp-select-existing_container").offset().top - 50}, 700);
        }

    }

	/*
	 * Things to do when page loads
	 */
    $(function () {

        /*
         * register events
         */
        // Prefix search
        $("form[name='prefix_search']").submit(function(e) {
            performPrefixSearch();
            e.preventDefault();
        });
        $('input[name="search_opt_parent"]').change(performPrefixSearch);
        $('input[name="search_opt_child"]').change(performPrefixSearch);
        $("#query_string").keyup(performPrefixSearch);

        // Expand pool button
        $("#exp_pool_btn").click(function() {
            $("#exp-method_container").show(); 
            $("html,body").animate({scrollTop: $("#exp-method_container").offset().top - 50}, 700); return false;
        });

        // Radio buttons regarding expansion method
        $('input[name="pool_exp_method_1"]').change(displayStep2);

		/*
		 * Other stuff
		 */
		// TODO: add highlight when hovering prefix in list
		// TODO: Fix error when prefix is selected multiple times

    });
    </script> 

{% endblock %}
{% block content %}

<div class="page-title">
Pool administration &mdash;&gt; edit pool
</div>

{% include 'pool_form.html' %}

<div class="options-group">
    <div class="options-content" style="position: relative;">
        <h3 class="options-group-heading">Prefixes in pool</h3>
        <div style="position: absolute; right: 20px; top: 48px; width: 100px;">
            {{ nap.button('Expand pool', color='red', url='', id='exp_pool_btn') }}
        </div>
        <table id="pool_prefix_list" style=" margin-top: 40px; border-spacing: 0px; width: 100%;">
            <thead class="listing">
                <tr>
                    <th>Prefix</th><th>Description</th><th>&nbsp;</th>
                    </tr>
            </thead>
            <tbody class="listing">
                {% for prefix in c.prefix_list %}
                <tr>
                    <td>{{ prefix.display_prefix }}</td>
                    <td>{{ prefix.description }}</td>
                    <td>
                        <a href="{{ h.url(controller = 'pool', action = 'remove_prefix', id = c.pool.id, prefix = prefix.id, schema = c.schema.id) }}">del</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="options-group" style="display: none;" id="exp-method_container">
    <div class="options-content">
        <h3 class="options-group-heading">Pool expansion method</h3>
        <table>
            <tr>
                <td width="120" valign="top">
                    <input id="radio-create-new" type="radio" name="pool_exp_method_1" value="create-new">
                    <label for="radio-create-new">Allocate new</label>
                </td>
                <td>Allocate a new prefix.</td>
            </tr>
            <tr>
                <td valign="top">
                    <input id="radio-use-existing" type="radio" name="pool_exp_method_1" value="use-existing">
                    <label for="radio-use-existing">Select existing</label>
                </td>
                <td>Add an already existing prefix to the pool.</td>
            </tr>
        </table>

    </div>
</div>

<div class="options-group" style="display: none;" id="exp-select-existing_container">
    <div class="options-content">
        <h3 class="options-group-heading">Select prefix</h3>
        {{ nap.prefix_search_form() }}
        {{ nap.prefix_search_result() }}
    </div>
</div>

{% endblock %}
