{% extends "base.html" %}
{% set page = 'prefixes' %}

{% block head %}

<script>

    /*
     * The prefix_list variable is used to keep a copy of all the prefixes
     * currently in the displayed list. Before adding, they are given a new
     * attribute: has_children. It is used to save information regarding
     * whether the prefix has children or not. These values are allowed:
     *  -2: We have no clue
     *  -1: At least one, but might be more (used for parent prefixes which
     *      was received when a prefix further down was requested including
     *      parents)
     *   0: No children
     *   1: Has children
     */
    var prefix_list = Object();
    var indent_head = Object();

    function showPrefix(prefix, parent_container) {

        // add main prefix container
        parent_container.append('<div id="prefix_entry' + prefix.id + '">');
        var prefix_entry = $('#prefix_entry' + prefix.id);
        prefix_entry.attr('class', 'prefix_entry');
        prefix_entry.hover(
            function() { prefix_entry.addClass("row_hover"); },
            function() { prefix_entry.removeClass("row_hover"); }
        );

        // add indent and prefix container
        prefix_entry.append('<div id="prefix_ind_pref' + prefix.id + '">');
        var prefix_ind_pref = $('#prefix_ind_pref' + prefix.id);
        prefix_ind_pref.addClass('prefix_ind_pref');

        // add indent
        prefix_ind_pref.append('<div id="prefix_indent' + prefix.id + '">');
        var prefix_indent = $('#prefix_indent' + prefix.id);
        prefix_indent.addClass("prefix_indent");

        // If the prefixes has children  (or we do not know), add expand button
        // TODO: this needs a cleanup. We have both the has_children attribute
        // and the type attribute which gives us information about this
        // (in case of type being 'host')
        if (prefix.has_children != 0) {

            // add expand button
            prefix_indent.html('<span class="exp_button" id="prefix_exp' + prefix.id + '" onClick="collapseClick(' + prefix.id + ')">&nbsp;+&nbsp;</span>');

            // If we are sure that the children has been fetched, the group will
            // already be fully expanded and a minus sign should be shown
            if (prefix.has_children == 1) {
                $("#prefix_exp" + prefix.id).html("&mbsp;-&nbsp;");
            }

        }

        prefix_indent.width(prefix_indent.width() + 30 * prefix.indent);

        // add prefix
        prefix_ind_pref.append('<div id="prefix_prefix' + prefix.id + '">');
        var prefix_prefix = $('#prefix_prefix' + prefix.id);
        prefix_prefix.addClass("prefix_prefix");
        prefix_prefix.html('<a href="/prefix/edit/' + prefix.id + '?schema={{ c.schema.id }}">' + prefix.display_prefix + '</a>');

        // Add prefix type
        prefix_entry.append('<div id="prefix_type' + prefix.id + '">');
        var prefix_type = $('#prefix_type' + prefix.id);
        prefix_type.addClass("prefix_type");
        prefix_type.html(prefix.type);

        // Add prefix description
        prefix_entry.append('<div id="prefix_description' + prefix.id + '">');
        var prefix_description = $('#prefix_description' + prefix.id);
        prefix_description.addClass("prefix_description");
        prefix_description.html(prefix.description);

    }

    /*
     * Callback function called when prefixes are received.
     * Plots prefixes and adds them to list.
     */
    function receivePrefixList(pref_list) {

        /*
         * Interpretation list
         */

        var intp_cont = $("#search_interpret_container");
        intp_cont.empty();
        for (key in pref_list.interpretation) {

            var interp = pref_list.interpretation[key];
            intp_cont.append('<div class="search_interpretation" id="intp' + key + '">');
            $('#intp' + key).html('<b>' + interp.string + '</b> interpreted as ' + interp.interpretation);

        }


        /*
         * Prefix list
         */

        $('#prefix_list').empty();

        prefix_list = new Object();
        indent_head = new Object();

        // add prefixes
        for (key in pref_list.result) {

            var cur_prefix = pref_list.result[key];
            prefix_list[cur_prefix.id] = cur_prefix;

            // Determine if the prefix has children of not.
            // A host never has
            if (cur_prefix.type == 'host') {
                cur_prefix.has_children = 0;
            // We do not know
            } else {
                cur_prefix.has_children = -2;
            }

            // if we miss a previous prefix, set prev_prefix to the current
            // (we need something...)
            // TODO: make less ugly ;)
            if (key - 1 in pref_list.result) {
                var prev_prefix = pref_list.result[key - 1];
            } else {
                var prev_prefix = cur_prefix;
            }

            // if there is no indent container for the current level, set
            // indent head for current indent level to the top level container
            if (!(cur_prefix.indent in indent_head)) {
                indent_head[cur_prefix.indent] = $('#prefix_list');
                console.log("Adding element to top level group");
            }

            // TODO: make this network aware. A network kan have a higher
            // indent than a previous one and still not belong to the
            // previous network's collapse group.
            if (cur_prefix.indent > prev_prefix.indent) {

                // we're adding to previous prefix's collapse group - expand it
                expandGroup(prev_prefix.id);

                // The previous prefix apparantly has at least one child
                prev_prefix.has_children = -1;
            }

            // Only display prefixes we are supposed to display
            // TODO: avoid creating alot of unneccesary collapse containers
            if (cur_prefix.display == true) {
                showPrefix(cur_prefix, indent_head[cur_prefix.indent]);
            }

            console.log("Added prefix " + cur_prefix.id + " (" + cur_prefix.display_prefix + ") to container " + indent_head[cur_prefix.indent].attr('id'));

            // add collapse container for current prefix
            // TODO: do not add if prefix is host
            indent_head[cur_prefix.indent].append('<div class="prefix_collapse" id="collapse' + cur_prefix.id + '">');
            indent_head[cur_prefix.indent + 1] = $('#collapse' + cur_prefix.id);
            console.log("Added collapse container " + indent_head[cur_prefix.indent + 1].attr('id'));

        }

    }


    /*
     * Translate form search options to depth levels
     */
    function optToDepth(opt) {

        switch (opt) {
            case 'none': return 0;
            case 'immediate': return 1;
            case 'all': return -1;
            default: return 0;
        }

    }

    /*
     * Perform a search operation
     */
    function performSearch() {

        var search_q = {
            'query_string': $('#query_string').val(),
            'schema': {{ c.schema.id }},
            'parents_depth': optToDepth($('input[name="search_opt_parent"]:checked').val()),
            'children_depth': optToDepth($('input[name="search_opt_child"]:checked').val()),
            'include_all_parents': 'true',
            'include_all_children': 'false',
            'max_result': 50,
            'offset': 0
        }

        $.getJSON("{{ h.url(controller = 'xhr', action = 'smart_search_prefix') }}", search_q, receivePrefixList);

    }

    /*
     * Function which is run when a collapse +/- sign is clicked.
     */
    function collapseClick(id) {

        // Determine if we need to fetch data
        if (prefix_list[id].has_children == -2) {

            // Yes, ask server for prefix list
            var data = {
                'schema': {{c.schema.id}},
                'id': id,
                'include_parents': false,
                'include_children': false,
                'parents_depth': 0,
                'children_depth': 1
            };
            $.getJSON("{{ h.url(controller = 'xhr', action = 'search_prefix') }}", data, insertPrefixList);

        } else {
            toggleGroup(id);
        }

    }

    /*
     * Insert prefixes into the list
     */
    function insertPrefixList(pref_list) {

        console.log('Got ' + pref_list.length + ' prefixes.');

        // Zero result elements. Should not happen as we at least always should
        // get the prefix we select to list, even if it has no children.
        if (pref_list.length == 0) {

            console.log('Warning: no prefixes returned from list operation.');
            return true;

        // One result element (the prefix we searched for)
        } else if (pref_list.length == 1) {

            // remove expand button
            $("#prefix_indent" + pref_list[0].id).html('&nbsp;');
            prefix_list[pref_list[0].id].has_children = 0;
            return true;

        }

        // OK, we got a bunch of prefixes to diplay. Where to put them?
        // Expand and locate collapse container
        expandGroup(pref_list[0].id);
        col_group = $('#collapse' + pref_list[0].id)

        // go through received prefixes
        for (key in pref_list) {

            // skip first prefix as that's the one that was clicked
            if (key == 0) {
                continue;
            }

            prefix = pref_list[key];

            // a host has no children, otherwise we do not know
            if (prefix.type == 'host') {
                prefix.has_children = 0;
            } else {
                prefix.has_children = -2;
            }

            prefix_list[prefix.id] = prefix;
            showPrefix(prefix, col_group)

            // add collapse container for current prefix
            // TODO: do not add if prefix is host
            col_group.append('<div class="prefix_collapse" id="collapse' + prefix.id + '">');
        }

        // Note that we now know that the parent now has children.
        prefix_list[pref_list[0].id].has_children = 1;

    }


    /*
     * Switches a collapse group
     */
    function toggleGroup(id) {

        var col = $('#collapse' + id);
        var exp = $('#prefix_exp' + id);

        if (col.css('display') == 'none') {
            expandGroup(id);
        } else {
            collapseGroup(id);
        }

    }

    /*
     * Expand a collapse group
     */
    function expandGroup(id) {

        var col = $('#collapse' + id);
        var exp = $('#prefix_exp' + id);

        col.slideDown();
        exp.html('&nbsp;-&nbsp;');

    }

    /*
     * Collapse a collapse group
     */
    function collapseGroup(id) {

        var col = $('#collapse' + id);
        var exp = $('#prefix_exp' + id);

        col.slideUp();
        exp.html('&nbsp;+&nbsp;');

    }

    $(function () {

        // register events
        $("form").submit(function(e) {
            performSearch();
            e.preventDefault();
        });
        $("#query_string").keyup(performSearch);
        $('input[name="search_opt_parent"]').change(performSearch);
        $('input[name="search_opt_child"]').change(performSearch);

        // set focus
        $("#query_string").focus();

    });

</script>

{% endblock %}

{% block menu %}
<div id="search_box">
    <form id="prefix_search" method="post">
        <center>
            <div style="padding-bottom: 2px; padding-top: 1px; position: relative;">
                <table cellspacing="0" cellpadding="0" border="0">
                    <tr>
                        <td>
                            <table>
                                <tr>
                                    <td style="padding-right: 20px">
                                        <input id="query_string" type="text" size="30" autocomplete="off" autofocus="autofocus">
                                    </td>
                                    <td>
                                        <div id="sbd">
                                            <input name="search_button" type="submit" value="Search"/>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <table border=0>
                                <tr>
                                    <td class="opt_left" name="search_interpret" style="border-bottom: 1px dotted #EEEEEE;">
                                        Search interpretation
                                    </td>
                                    <td class="opt_right" id="search_interpret_container" style="border-bottom: 1px dotted #999999;"> </td>
                                </tr>
                                <tr>
                                    <td class="opt_left">
                                        Display options
									</td>
									<td class="opt_right">
										<table>
											<tr>
												<td style="text-align: right; padding: 0; margin: 0;">
													Include parent:
												</td>
												<td style="padding: 0; margin: 0;">

												{% if c.search_opt_parent == 'none' %}
													<input type="radio" name="search_opt_parent" value="none" checked>none</input>
												{% else %}
													<input type="radio" name="search_opt_parent" value="none">none</input>
												{% endif %}

												{% if c.search_opt_parent == 'immediate' %}
													<input type="radio" name="search_opt_parent" value="immediate" checked>immediate</input>
												{% else %}
													<input type="radio" name="search_opt_parent" value="immediate">immediate</input>
												{% endif %}

												{% if c.search_opt_parent == 'all' %}
													<input type="radio" name="search_opt_parent" value="all" checked>all</input>
												{% else %}
													<input type="radio" name="search_opt_parent" value="all">all</input>
												{% endif %}

												</td>
											</tr>
											<tr>
												<td style="text-align: right; padding: 0; margin: 0;">
													Include children:
												</td>
												<td style="padding: 0; margin: 0;">

												{% if c.search_opt_child == 'none' %}
													<input type="radio" name="search_opt_child" value="none" checked>none
												{% else %}
													<input type="radio" name="search_opt_child" value="none">none
												{% endif %}

												{% if c.search_opt_child == 'immediate' %}
													<input type="radio" name="search_opt_child" value="immediate" checked>immediate
												{% else %}
													<input type="radio" name="search_opt_child" value="immediate">immediate
												{% endif %}

												{% if c.search_opt_child == 'all' %}
													<input type="radio" name="search_opt_child" value="all" checked>all
												{% else %}
													<input type="radio" name="search_opt_child" value="all">all
												{% endif %}

												</td>
											</tr>
										</table>

                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
				<div style="position: absolute; right: 10px; top: 4px;">
					{{ button('Add prefix', color='red', url=h.url(controller = 'prefix', action = 'add', schema = c.schema.id)) }}
				</div>
            </div>
        </center>
    </form>
</div>

{% endblock %}



{% block content %}

<div id="prefix_list">
</div>

{% endblock %}
