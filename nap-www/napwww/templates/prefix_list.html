{% extends "base.html" %}

{% block head %}

<script>

    var prefix_list = Object();
    var indent_head = Object();
        
    function showPrefix(prefix, parent_container) {

        // add main prefix container
        parent_container.append('<div id="prefix_entry' + prefix.id + '">');
        var prefix_entry = $('#prefix_entry' + prefix.id);
        prefix_entry.attr('class', 'prefix_entry');
        prefix_entry.hover(
            function() { prefix_entry.addClass("row_hover"); },
            function() { prefix_entry.removeClass("row_hover"); }
        );

        // add indent and prefix container
        prefix_entry.append('<div id="prefix_ind_pref' + prefix.id + '">');
        var prefix_ind_pref = $('#prefix_ind_pref' + prefix.id);
        prefix_ind_pref.addClass('prefix_ind_pref');

        // add indent
        prefix_ind_pref.append('<div id="prefix_indent' + prefix.id + '">');
        var prefix_indent = $('#prefix_indent' + prefix.id);
        prefix_indent.addClass("prefix_indent");

		// add expand button
        prefix_indent.html('<span class="exp_button" id="prefix_exp' + prefix.id + '" onClick="toggleGroup(' + prefix.id + ')">&nbsp;+&nbsp;</span>');
		// If we are sure that the children has been fetched, the group will
		// already be fully expanded and a minus sign should be shown
		if (prefix.children_fetched) {
			$("#prefix_exp" + prefix.id).html("&mbsp;-&nbsp;");
		}

        prefix_indent.width(prefix_indent.width() + 30 * prefix.indent);

        // add prefix
        prefix_ind_pref.append('<div id="prefix_prefix' + prefix.id + '">');
        var prefix_prefix = $('#prefix_prefix' + prefix.id);
        prefix_prefix.addClass("prefix_prefix");
        prefix_prefix.html('<a href="/prefix/edit/' + prefix.id + '?schema={{ c.schema.id }}">' + prefix.display_prefix + '</a>');

        // Add prefix type
        prefix_entry.append('<div id="prefix_type' + prefix.id + '">');
        var prefix_type = $('#prefix_type' + prefix.id);
        prefix_type.addClass("prefix_type");
        prefix_type.html(prefix.type);

        // Add prefix description
        prefix_entry.append('<div id="prefix_description' + prefix.id + '">'); 
        var prefix_description = $('#prefix_description' + prefix.id);
        prefix_description.addClass("prefix_description");
        prefix_description.html(prefix.description);

    }

    /*
     * Callback function called when prefixes are received.
     * Plots prefixes and adds them to list.
     */
    function receivePrefixList(pref_list) {

        /*
         * Interpretation list
         */

        var intp_cont = $("#search_interpret_container");
        intp_cont.empty();
        for (key in pref_list.interpretation) {

            var interp = pref_list.interpretation[key];
            intp_cont.append('<div class="search_interpretation" id="intp' + key + '">');
            $('#intp' + key).html('<b>' + interp.string + '</b> interpreted as ' + interp.interpretation);

        }


        /*
         * Prefix list
         */

        $('#prefix_list').empty();

		prefix_list = new Object();
		indent_head = new Object();

        // add prefixes
        for (key in pref_list.result) {

            var cur_prefix = pref_list.result[key];
			cur_prefix.children_fetched = false;
            prefix_list[cur_prefix.id] = cur_prefix;

			// if we miss a previous prefix, set prev_prefix to the current
			// (we need something...)
			// TODO: make less ugly ;)
			if (key - 1 in pref_list.result) {
            	var prev_prefix = pref_list.result[key - 1];
			} else {
				var prev_prefix = cur_prefix;
			}

			// if there is no indent container for the current level, set
			// indent head for current indent level to the top level container
			if (!(cur_prefix.indent in indent_head)) {
				indent_head[cur_prefix.indent] = $('#prefix_list');
				console.log("Adding element to top level group");
			}

			// TODO: make this network aware. A network kan have a higher
			// indent than a previous one and still not belong to the 
			// previous network's collapse group.
            if (cur_prefix.indent > prev_prefix.indent) {
				// we're adding to previous prefix's collapse group - expand it
				expandGroup(prev_prefix.id);
            }

            showPrefix(cur_prefix, indent_head[cur_prefix.indent]);
			console.log("Added prefix " + cur_prefix.id + " (" + cur_prefix.display_prefix + ") to container " + indent_head[cur_prefix.indent].attr('id'));

			// add collapse container for current prefix
			// TODO: do not add if prefix is host
            indent_head[cur_prefix.indent].append('<div class="prefix_collapse" id="collapse' + cur_prefix.id + '">');
            indent_head[cur_prefix.indent + 1] = $('#collapse' + cur_prefix.id);
			console.log("Added collapse container " + indent_head[cur_prefix.indent + 1].attr('id'));

        }

    }

    /*
     * Perform a search operation
     */
    function performSearch() {

        var search_q = {
            'query_string': $('#query_string').val(),
            'schema': {{ c.schema.id }},
            'search_opt_parent': $('input[name="search_opt_parent"]:checked').val(),
            'search_opt_child': $('input[name="search_opt_child"]:checked').val()
        }

        $.getJSON("{{ h.url(controller='xhr', action='smart_search_prefix') }}", search_q, receivePrefixList);

    }

    /*
     * Switches a collapse group
     */
    function toggleGroup(id) {

        var col = $('#collapse' + id);
        var exp = $('#prefix_exp' + id);

        if (col.css('display') == 'none') {
			expandGroup(id);
        } else {
			collapseGroup(id);
        }
        
    }

	/*
	 * Expand a collapse group
	 */
	function expandGroup(id) {

        var col = $('#collapse' + id);
        var exp = $('#prefix_exp' + id);

        col.slideDown();
        exp.html('&nbsp;-&nbsp;');

	}

	/*
	 * Collapse a collapse group
	 */
	function collapseGroup(id) {

        var col = $('#collapse' + id);
        var exp = $('#prefix_exp' + id);

        col.slideUp();
        exp.html('&nbsp;+&nbsp;');

	}

    $(function () {

        // register events
        $("form").submit(function(e) {
            performSearch();
            e.preventDefault();
        });
        $("#query_string").keyup(performSearch);
        $('input[name="search_opt_parent"]').change(performSearch);
        $('input[name="search_opt_child"]').change(performSearch);

        // set focus
        $("#query_string").focus();

    });

</script>

{% endblock %}

{% block content %}

<a href="{{ h.url(controller='prefix', action='list', schema=c.schema.id, view='prefix') }}">prefix</a> | 
<a href="{{ h.url(controller='prefix', action='list', schema=c.schema.id, view='pool') }}">pool</a>

<center>
    <form id="prefix_search" method="post">
        <input id="query_string" type="text" size="50" autocomplete="off" autofocus="autofocus">
        <input type="submit" value="Search">
    </form>
</center>
<table>
    <tr>
        <td width="40">&nbsp;</td>
        <td class="opt_left">
            Search interpretation
        </td>
        <td class="opt_right" id="search_interpret_container"> </td>
    </tr>
    <tr>
        <td width="40">&nbsp;</td>
        <td class="opt_left">
            Display options
        </td><td class="opt_right">
            Include parent:

        {% if c.search_opt_parent == 'none' %}
            <input type="radio" name="search_opt_parent" value="none" checked>none</input>
        {% else %}
            <input type="radio" name="search_opt_parent" value="none">none</input>
        {% endif %}

        {% if c.search_opt_parent == 'immediate' %}
            <input type="radio" name="search_opt_parent" value="immediate" checked>immediate</input>
        {% else %}
            <input type="radio" name="search_opt_parent" value="immediate">immediate</input>
        {% endif %}

        {% if c.search_opt_parent == 'all' %}
            <input type="radio" name="search_opt_parent" value="all" checked>all</input>
        {% else %}
            <input type="radio" name="search_opt_parent" value="all">all</input>
        {% endif %}

            <br>Include children:

        {% if c.search_opt_child == 'none' %}
            <input type="radio" name="search_opt_child" value="none" checked>none
        {% else %}
            <input type="radio" name="search_opt_child" value="none">none
        {% endif %}

        {% if c.search_opt_child == 'immediate' %}
            <input type="radio" name="search_opt_child" value="immediate" checked>immediate
        {% else %}
            <input type="radio" name="search_opt_child" value="immediate">immediate
        {% endif %}

        {% if c.search_opt_child == 'all' %}
            <input type="radio" name="search_opt_child" value="all" checked>all
        {% else %}
            <input type="radio" name="search_opt_child" value="all">all
        {% endif %}
        </td>
    </tr>
</table>
<div id="prefix_list">
</div>

{% endblock %}
